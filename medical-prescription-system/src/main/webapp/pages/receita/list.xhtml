<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Receitas</title>
    <style>
        .page { max-width: 980px; margin: 24px auto; padding: 0 12px; font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: .5rem; align-items: center; }
        .filters { display: grid; grid-template-columns: 1fr 1fr auto auto; gap: .5rem; }
    </style>
</h:head>
<h:body>
    <div class="page">
        <h:form id="form">
            <p:growl id="growl" showDetail="true" life="3500"/>
            <p:messages id="msgs" showDetail="true" closable="true"/>

            <h1>Receitas</h1>

            <div class="toolbar">
                <div class="filters">
                    <!-- Paciente por ID -->
                    <p:autoComplete id="pac"
                                    value="#{receitaConsultaBean.pacienteId}"
                                    completeMethod="#{receitaConsultaBean.autoCompletePaciente}"
                                    var="p" itemLabel="#{p.nome} - #{p.cpf}" itemValue="#{p.id}"
                                    forceSelection="true"
                                    dropdown="true" placeholder="Paciente"/>

                    <!-- Medicamento por ID -->
                    <p:autoComplete id="med"
                                    value="#{receitaConsultaBean.medicamentoId}"
                                    completeMethod="#{receitaConsultaBean.autoCompleteMedicamento}"
                                    var="m" itemLabel="#{m.nome}" itemValue="#{m.id}"
                                    forceSelection="true"
                                    dropdown="true" placeholder="Medicamento"/>

                    <p:commandButton value="Pesquisar" icon="pi pi-search"
                                     process="@form" update=":form:tabela"/>
                    <p:commandButton value="Limpar" icon="pi pi-times"
                                     actionListener="#{receitaConsultaBean.limparFiltros}"
                                     update=":form:pac,:form:med,:form:tabela"/>
                </div>

                <p:button value="Novo" icon="pi pi-plus"
                          href="#{request.contextPath}/pages/receita/form.xhtml"/>
                <p:button value="Voltar" icon="pi pi-arrow-left"
                          href="#{request.contextPath}"/>
            </div>

            <p:dataTable id="tabela" value="#{receitaConsultaBean.model}" var="r"
                         lazy="true" paginator="true" rows="10" rowsPerPageTemplate="10,20,50"
                         emptyMessage="Nenhuma receita encontrada." styleClass="p-datatable-sm">

                <!-- r: Object[] => [id, pacienteNome, criadaEm, totalItens] -->
                <p:column headerText="ID" style="width:90px; text-align:center">#{r[0]}</p:column>
                <p:column headerText="Paciente">#{r[1]}</p:column>
                <p:column headerText="Criada em" style="width:220px">#{r[2]}</p:column>
                <p:column headerText="Qtde. Itens" style="width:120px; text-align:center">#{r[3]}</p:column>
                <p:column headerText="Ações" style="width:200px; text-align:center">
                    <p:commandButton value="Itens" icon="pi pi-list"
                                     actionListener="#{receitaConsultaBean.abrirItens(r[0])}"
                                     update=":form:dlgItens" oncomplete="PF('dlgItens').show()"/>
                </p:column>
            </p:dataTable>

            <p:dialog id="dlgItens" header="Medicamentos da Receita" widgetVar="dlgItens"
                      modal="true" resizable="false" width="460">
                <p:dataList value="#{receitaConsultaBean.itensDaReceita}" var="it" type="ordered">
                    #{it}
                </p:dataList>
                <p:spacer height="6"/>
                <p:commandButton type="button" value="Fechar" icon="pi pi-check"
                                 onclick="PF('dlgItens').hide()"/>
            </p:dialog>
        </h:form>
    </div>
</h:body>
</html>
